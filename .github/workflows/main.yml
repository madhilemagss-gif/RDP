name: France Runner (Tailscale)

on:
  workflow_dispatch:

jobs:
  france-windows:
    runs-on: [self-hosted, windows, france]
    timeout-minutes: 120

    steps:
      - name: Show runner info
        shell: pwsh
        run: |
          Write-Host "Hostname: $(hostname)"
          Write-Host "OS: $((Get-CimInstance Win32_OperatingSystem).Caption)"
          Write-Host "Timezone: $((Get-TimeZone).Id)"

      - name: Ensure Tailscale is installed
        shell: pwsh
        run: |
          $ts = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe'
          if (-not (Test-Path $ts)) {
            throw "Tailscale is not installed on this self-hosted runner. Install it once on the VM, then rerun."
          }

      - name: Bring up Tailscale (idempotent)
        shell: pwsh
        run: |
          $ts = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe'

          # If already logged in/connected, don't disrupt it
          $statusJson = & $ts status --json 2>$null
          if ($LASTEXITCODE -ne 0 -or -not $statusJson) {
            Write-Host "Tailscale not up yet. Bringing it up..."
            & $ts up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=fr-gh-runner-${{ github.run_id }}
          } else {
            Write-Host "Tailscale already up."
          }

          $ip = (& $ts ip -4).Trim()
          if (-not $ip) { throw "Failed to obtain Tailscale IPv4." }

          "TAILSCALE_IP=$ip" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Show Tailscale IP (use this to RDP over Tailnet)
        shell: pwsh
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "RDP tip: connect to $env:TAILSCALE_IP:3389 from a device on the same Tailnet"
